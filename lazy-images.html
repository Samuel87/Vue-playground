<style type="text/css">
    :root {
        --ratio-16-9: 56.25%;
        --ratio-4-3: 75%;
        --ratio-3-2: 66.66%;
    }

    img {
        width: 100%;
        height: auto;
    }

    .grid {
        display: flex;
        flex-wrap: wrap;
    }

    .col-6 {
        width: 100%;
        flex: 0 0 50%;
        max-width: 50%;
    }

    .image {
        height: 0;
        position: relative;
        overflow: hidden;
    }

    .image-16-9 {
        padding-bottom: var(--ratio-16-9);
    }

    .image img {
        position: absolute;
        top: -50%;
        left: -50%;
        right: -50%;
        bottom: -50%;
        margin: auto;
    }
</style>

<div id="app">
    <div class="grid">
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
        <div class="col-6">
            <div class="image image-16-9">
                <lazy-image
                    srcset="http://via.placeholder.com/1024x1024 640w,
                            http://via.placeholder.com/1920x1080 1024w"
                    src="http://via.placeholder.com/1920x1920"
                    src-placeholder="http://via.placeholder.com/100x100"
                ></lazy-image>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>

const LazyImage = {
    inheritAttrs: false,
    props: {
        src: {
            type: String,
            required: true,
        },
        srcPlaceholder: {
            type: String,
            default: '',
        },
        srcset: {
            type: String,
        },
        intersectionOptions: {
            type: Object,
            default: () => ({}),
        },
    },
    data: () => ({
        observer: null,
        intersected: false,
        loaded: false,
        intersectionSupported: 'IntersectionObserver' in window,
    }),
    computed: {
        srcImage() {
            return !this.intersectionSupported ? this.src : this.intersected ? this.src : this.srcPlaceholder;
        },
        srcsetImage() {
            if (this.intersectionSupported) {
                return this.intersected && this.srcset ? this.srcset : false;
            }

            return this.srcset ? this.srcset : false;
        },
    },
    mounted() {
        if (this.intersectionSupported) {
            this.observer = new IntersectionObserver((entries) => {
                const image = entries[0];
                if (image.isIntersecting) {
                    this.intersected = true;
                    this.observer.disconnect();
                    this.$emit('intersect');
                }
            }, this.intersectionOptions);
            this.observer.observe(this.$el);
        } else {
            console.error('IntersectionObserver not supported - image lazy loading cancelled.');
        }
    },
    destroyed() {
        if (this.intersectionSupported) {
            this.observer.disconnect();
        }
    },
    methods: {
        load() {
            if (this.$el.getAttribute('src') !== this.srcPlaceholder) {
                this.loaded = true;
                this.$emit('load');
            }
        },
    },
    render(h) {
        return h('img', {
            attrs: {
                src: this.srcImage,
                srcset: this.srcsetImage,
            },
            domProps: this.$attrs,
            class: {
                'lazy-image': true,
                'lazy-image-loaded': this.loaded,
            },
            on: { load: this.load },
        });
    },
};

new Vue({
    el: '#app',
    components: {
        LazyImage,
    },
});

</script>
